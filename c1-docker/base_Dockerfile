FROM dockyard.cloud.capitalone.com/base/ubuntu:trusty_16.04
 
MAINTAINER Maashu Cloney <matthew.cloney@capitalone.com>

ARG proxy=http://10.12.195.66:8099

ENV DEBIAN_FRONTEND=noninteractive
ENV http_proxy ${proxy}
ENV https_proxy ${proxy}
ENV HTTP_PROXY ${proxy}
ENV HTTPS_PROXY ${proxy}

RUN mkdir -p /home/streamuser
WORKDIR /home/streamuser

COPY requirements.txt /home/streamuser/

COPY setup-ubuntu-proxy.sh /home/streamuser/

RUN chmod +x /home/streamuser/setup-ubuntu-proxy.sh && /home/streamuser/setup-ubuntu-proxy.sh

# Install pip, wheel, virtualenv, curl, wget, Java, JDK, etc.
RUN apt-get update -y && \
    apt-get install --no-install-recommends -y software-properties-common build-essential && \
    apt-get install -y python python-setuptools python-dev python-pip python-wheel python-virtualenv curl xz-utils ca-certificates wget openjdk-7-jre openjdk-7-jdk vim git tmux man

# Download and install Anaconda
# RUN wget -v https://repo.continuum.io/archive/Anaconda3-4.4.0-Linux-x86_64.sh -e use_proxy=yes -e http_proxy=${proxy} -e HTTP_PROXY=${proxy} -e https_proxy=${proxy} -e HTTPS_PROXY=${proxy}
RUN wget https://artifactory.cloud.capitalone.com/artifactory/z-cloudnexus-releases-cache/io/continuum/Anaconda3/4.3.0/Anaconda3-4.3.0-Linux-x86_64.sh

RUN bash Anaconda3-4.3.0-Linux-x86_64.sh -b

# download Spark and Zookeeper from Artifactory
RUN wget https://artifactory.cloud.capitalone.com/artifactory/z-cloudnexus-cisnapshots-cache/com/apache/spark/2.1.1/spark-2.1.1-hadoop2.7.tgz
RUN wget https://artifactory.cloud.capitalone.com/artifactory/z-cloudnexus-releases-cache/org/apache/zookeeper/zookeeper/3.4.10/zookeeper-3.4.10.tar.gz

# un-tar these files
RUN tar -xvzf spark-2.1.1-hadoop2.7.tgz
RUN tar -xvzf zookeeper-3.4.10.tar.gz

# move into the /opt directory
RUN mv spark-2.1.1-bin-hadoop2.7/ /opt/spark
RUN mv zookeeper-3.4.10/ /opt/zookeeper

# cleanup
RUN rm spark-2.1.1-hadoop2.7.tgz
RUN rm zookeeper-3.4.10.tar.gz
RUN rm Anaconda3-4.3.0-Linux-x86_64.sh

WORKDIR /home/streamuser

COPY requirements.txt /home/streamuser/

# for Jupyter
EXPOSE 8888

# set environment variables
ENV SPARK_HOME=/opt/spark
ENV KAFKA_HOME=/opt/kafka
ENV ZK_HOME=/opt/zookeeper
ENV PYTHONPATH=$SPARK_HOME/python:$SPARK_HOME/python/build:$PYTHONPATH
ENV PYTHONPATH=$SPARK_HOME/python/lib/py4j-0.10.4-src.zip:$PYTHONPATH
ENV PATH=/root/anaconda3/bin:$PATH
